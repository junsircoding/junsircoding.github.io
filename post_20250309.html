<!DOCTYPE html>

<html lang="zh-CN" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />


<title>处理气象数据常用的插值方法
    
    -小骏不抬杠
    
</title>


























<meta name='description' content='气象,插值,interp,scipy,wrf,grid,Matplotlib,反距离权重插值,idw,meteva,panoply,网格数据,站点数据,网格数据,pandas,xarray'>


<meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b86133f3" />
    <link rel="stylesheet" type="text/css" href="_static/pydoctheme.css?v=23252803" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link id="pygments_dark_css" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css" href="_static/pygments_dark.css?v=5349f25f" />
    <link rel="stylesheet" type="text/css" href="_static/css/custom.css?v=3d2a89a3" />
    
    <script src="_static/documentation_options.js?v=91bfbbb6"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/translations.js?v=beaddf03"></script>
    <script src="_static/js/custom.js?v=b7a94a21"></script>
    
    <link rel="canonical" href="https://junsircoding.github.io/post_20250309.html" />
    <link rel="icon" href="_static/favicon.ico"/>
    <link rel="index" title="索引" href="genindex.html" />
    <link rel="search" title="搜索" href="search.html" />
    <link rel="next" title="2025 年展望" href="post_20250302.html" />
    <link rel="prev" title="小骏不抬杠" href="index.html" />
<link rel="stylesheet" href="_static/pydoctheme_dark.css" media="(prefers-color-scheme: dark)" id="pydoctheme_dark_css">
    <link rel="shortcut icon" type="image/png" href="_static/favicon.svg" />
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4178487904865687" crossorigin="anonymous"></script>
    <meta name="google-adsense-account" content="ca-pub-4178487904865687">
            <script type="text/javascript" src="_static/copybutton.js"></script>
            <script type="text/javascript" src="_static/menu.js"></script>
            <script type="text/javascript" src="_static/search-focus.js"></script> 
<script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "kb72rmcxcn");
</script>

  </head>
<body>
<div class="mobile-nav">
    <input type="checkbox" id="menuToggler" class="toggler__input" aria-controls="navigation"
           aria-pressed="false" aria-expanded="false" role="button" aria-label="Menu" />
    <nav class="nav-content" role="navigation">
        <label for="menuToggler" class="toggler__label">
            <span></span>
        </label>
        <span class="nav-items-wrapper">
            <a href="https://junsircoding.github.io" class="nav-logo">
                <img src="_static/favicon.svg" alt="小骏不抬杠"/>
            </a>
            <span class="version_switcher_placeholder"></span>
            <form role="search" class="search" action="search.html" method="get">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" class="search-icon">
                    <path fill-rule="nonzero" fill="currentColor" d="M15.5 14h-.79l-.28-.27a6.5 6.5 0 001.48-5.34c-.47-2.78-2.79-5-5.59-5.34a6.505 6.505 0 00-7.27 7.27c.34 2.8 2.56 5.12 5.34 5.59a6.5 6.5 0 005.34-1.48l.27.28v.79l4.25 4.25c.41.41 1.08.41 1.49 0 .41-.41.41-1.08 0-1.49L15.5 14zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path>
                </svg>
                <input placeholder="快速搜索" aria-label="快速搜索" type="search" name="q" />
                <input type="submit" value="提交"/>
            </form>
        </span>
    </nav>
    <div class="menu-wrapper">
        <nav class="menu" role="navigation" aria-label="main navigation">
            <div class="language_switcher_placeholder"></div>
            
<label class="theme-selector-label">
    Theme
    <select class="theme-selector" oninput="changeTheme(this.value)">
        <option value="auto" selected>Auto</option>
        <option value="light">Light</option>
        <option value="dark">Dark</option>
    </select>
</label>
  <div>
    <h3><a href="index.html">目录</a></h3>
    <ul>
<li><a class="reference internal" href="#">处理气象数据常用的插值方法</a><ul>
<li><a class="reference internal" href="#id3">站点数据</a></li>
<li><a class="reference internal" href="#id5">网格数据</a></li>
<li><a class="reference internal" href="#id7">将网格数据插值到另一个坐标、分辨率不同的网格坐标上</a></li>
<li><a class="reference internal" href="#id8">将网格数据插值到站点数据上</a></li>
<li><a class="reference internal" href="#id9">将站点数据插值到网格数据上（反距离权重插值）</a></li>
<li><a class="reference internal" href="#id10">示例数据下载</a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>上一主题</h4>
    <p class="topless"><a href="index.html"
                          title="上一章">小骏不抬杠</a></p>
  </div>
  <div>
    <h4>下一主题</h4>
    <p class="topless"><a href="post_20250302.html"
                          title="下一章">2025 年展望</a></p>
  </div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">快速搜索</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="提交" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </nav>
    </div>
</div>
  

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>导航</h3>
      <ul>
          <li><img src="_static/favicon.svg" alt="小骏不抬杠" style="vertical-align: middle; margin-top: -1px"/></li>
          <li><a href="https://junsircoding.github.io">小骏不抬杠</a> &#187;</li>
          <li class="switchers">
            <div class="language_switcher_placeholder"></div>
            <div class="version_switcher_placeholder"></div>
          </li>
          <li>
              
          </li>

            <li class="nav-item nav-item-this"><a href="">处理气象数据常用的插值方法</a></li>

            
                <li class="right">
                    

    <div class="inline-search" role="search">
        <form class="inline-search" action="search.html" method="get">
          <input placeholder="快速搜索" aria-label="快速搜索" type="search" name="q" id="search-box" />
          <input type="submit" value="提交" />
        </form>
    </div>
                </li>
            <li class="right">
<label class="theme-selector-label">
    Theme
    <select class="theme-selector" oninput="changeTheme(this.value)">
        <option value="auto" selected>Auto</option>
        <option value="light">Light</option>
        <option value="dark">Dark</option>
    </select>
</label> |</li>
            
      </ul>
    </div>  
  

<div class="document">
  <div class="documentwrapper">
    
    <div class="bodywrapper">
            
            <div class="body" role="main">
                
  <section id="id1">
<h1>处理气象数据常用的插值方法<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h1>
<blockquote>
<div><p>注：</p>
<p>这篇文章与 <a class="reference external" href="https://junsircoding.github.io/post_20230529.html">气象数据的各种插值问题</a> 内容大致相同，是它的重构版。相比旧版，修改了 IDW 插值的代码，删掉了一些与主题关联不大的段落。
这个版本的 IDW 插值函数无须安装第三方库，仅依赖基础的 <a class="reference external" href="https://matplotlib.org/stable/gallery/misc/keyword_plotting.html#sphx-glr-gallery-misc-keyword-plotting-py">Scipy</a> 库即可使用。
实际工作时，有时不太方便因为要使用一个功能，而在已有的 Python 中环境继续安装其他扩展库，一是 conda 环境中安装的库越多，
再新增库就越慢；二是有可能会连带修改其他库的版本，导致业务中有些代码不能使用。
所以针对单一功能以提取出仅依赖基础库就能使用的版本为宜。</p>
</div></blockquote>
<p>气象业务当中，比较常见的数据形式有 <strong>站点数据</strong> 和 <strong>网格数据</strong>  。</p>
<section id="id3">
<h2>站点数据<a class="headerlink" href="#id3" title="Link to this heading">¶</a></h2>
<p><strong>站点数据</strong> 就是个二维数据表，一般是 CSV、TXT、或者 Excel 等格式，这里我们用一个 CSV 数据（ <em>UPA_obs.csv</em> <a class="footnote-reference brackets" href="#id11" id="id4" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a> ）举例。</p>
<p>用 <a class="reference external" href="https://docs.xarray.dev/en/stable/getting-started-guide/quick-overview.html">Pandas</a> 读取：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="linenos">2</span>
<span class="linenos">3</span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;UPA_obs.csv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
<span class="linenos">4</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">,</span> <span class="s2">&quot;temperature&quot;</span><span class="p">]]</span>
<span class="linenos">5</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;any&quot;</span><span class="p">)</span>
<span class="linenos">6</span><span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
<span class="linenos">7</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;temperature&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;temperature&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos">8</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="s2">&quot;value&quot;</span><span class="p">})</span>
</pre></div>
</div>
<p>结构就像这样：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>        <span class="n">lat</span>         <span class="n">lon</span>  <span class="n">value</span>
<span class="mi">0</span>    <span class="mf">51.466667</span>  <span class="o">-</span><span class="mf">90.200000</span>  <span class="o">-</span><span class="mf">43.5</span>
<span class="mi">1</span>    <span class="mf">51.466667</span>  <span class="o">-</span><span class="mf">90.200000</span>  <span class="o">-</span><span class="mf">53.9</span>
<span class="mi">2</span>    <span class="mf">53.533333</span> <span class="o">-</span><span class="mf">114.083333</span>  <span class="o">-</span><span class="mf">28.3</span>
<span class="mi">3</span>    <span class="mf">53.533333</span> <span class="o">-</span><span class="mf">114.083333</span>  <span class="o">-</span><span class="mf">53.5</span>
<span class="mi">4</span>    <span class="mf">53.750000</span>  <span class="o">-</span><span class="mf">73.666667</span>  <span class="o">-</span><span class="mf">41.7</span>
<span class="o">..</span>         <span class="o">...</span>         <span class="o">...</span>    <span class="o">...</span>
<span class="mi">177</span>  <span class="mf">34.733333</span> <span class="o">-</span><span class="mf">120.583333</span>  <span class="o">-</span><span class="mf">42.3</span>
<span class="mi">178</span>  <span class="mf">40.900000</span> <span class="o">-</span><span class="mf">117.800000</span>  <span class="o">-</span><span class="mf">16.8</span>
<span class="mi">179</span>  <span class="mf">40.900000</span> <span class="o">-</span><span class="mf">117.800000</span>  <span class="o">-</span><span class="mf">44.2</span>
<span class="mi">180</span>  <span class="mf">46.466667</span>  <span class="o">-</span><span class="mf">84.366667</span>  <span class="o">-</span><span class="mf">39.1</span>
<span class="mi">181</span>  <span class="mf">46.466667</span>  <span class="o">-</span><span class="mf">84.366667</span>  <span class="o">-</span><span class="mf">48.1</span>

<span class="p">[</span><span class="mi">182</span> <span class="n">rows</span> <span class="n">x</span> <span class="mi">3</span> <span class="n">columns</span><span class="p">]</span>
</pre></div>
</div>
<p>其中 <code class="docutils literal notranslate"><span class="pre">lat</span></code> 表示纬度， <code class="docutils literal notranslate"><span class="pre">lon</span></code> 表示经度， <code class="docutils literal notranslate"><span class="pre">value</span></code> 表示站点观测值。</p>
<p>把这个数据在地图上以打点的形式画出来，点的颜色对应数值大小：</p>
<figure class="align-default">
<img alt="站点数据原始绘图" src="_images/002.png" />
</figure>
<p>可以看到，这个数据内容是北美的气温数据，每个点的颜色代表了温度的大小，温度单位是摄氏度（℃）。
我们把温度的显示范围设定在了 -60 ~ -30 ℃ 之间，以便让各个颜色区域都有值。</p>
<p>画图脚本如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="linenos"> 4</span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="linenos"> 5</span><span class="kn">import</span><span class="w"> </span><span class="nn">cartopy.crs</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ccrs</span>
<span class="linenos"> 6</span><span class="kn">import</span><span class="w"> </span><span class="nn">cartopy.feature</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cfeature</span>
<span class="linenos"> 7</span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mpl</span>
<span class="linenos"> 8</span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="linenos"> 9</span><span class="kn">from</span><span class="w"> </span><span class="nn">cartopy.mpl.ticker</span><span class="w"> </span><span class="kn">import</span> <span class="n">LongitudeFormatter</span><span class="p">,</span> <span class="n">LatitudeFormatter</span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.sans-serif&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Microsoft YaHei&#39;</span><span class="p">]</span>
<span class="linenos">12</span><span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.unicode_minus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos">13</span>
<span class="linenos">14</span><span class="c1"># 读取数据</span>
<span class="linenos">15</span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;UPA_obs.csv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
<span class="linenos">16</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">,</span> <span class="s2">&quot;temperature&quot;</span><span class="p">]]</span>
<span class="linenos">17</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;any&quot;</span><span class="p">)</span>
<span class="linenos">18</span><span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
<span class="linenos">19</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;temperature&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;temperature&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos">20</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="s2">&quot;value&quot;</span><span class="p">})</span>
<span class="linenos">21</span><span class="c1"># 计算经纬度范围</span>
<span class="linenos">22</span><span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">,</span> <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">df</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">df</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">df</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="linenos">23</span><span class="n">lon_buffer</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">lon_max</span> <span class="o">-</span> <span class="n">lon_min</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span>
<span class="linenos">24</span><span class="n">lat_buffer</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">lat_max</span> <span class="o">-</span> <span class="n">lat_min</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span>
<span class="linenos">25</span><span class="n">map_extent</span> <span class="o">=</span> <span class="p">[</span><span class="n">lon_min</span> <span class="o">-</span> <span class="n">lon_buffer</span><span class="p">,</span> <span class="n">lon_max</span> <span class="o">+</span> <span class="n">lon_buffer</span><span class="p">,</span> <span class="n">lat_min</span> <span class="o">-</span> <span class="n">lat_buffer</span><span class="p">,</span> <span class="n">lat_max</span> <span class="o">+</span> <span class="n">lat_buffer</span><span class="p">]</span>
<span class="linenos">26</span>
<span class="linenos">27</span><span class="c1"># 绘图</span>
<span class="linenos">28</span><span class="n">proj</span> <span class="o">=</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()</span>
<span class="linenos">29</span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
<span class="linenos">30</span><span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">proj</span><span class="p">)</span>
<span class="linenos">31</span>
<span class="linenos">32</span><span class="n">cmap</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colormaps</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;jet&#39;</span><span class="p">)</span>
<span class="linenos">33</span><span class="n">img</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">proj</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=-</span><span class="mi">30</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">60</span><span class="p">)</span>
<span class="linenos">34</span>
<span class="linenos">35</span><span class="c1"># 设置绘图经纬度区域</span>
<span class="linenos">36</span><span class="n">ax</span><span class="o">.</span><span class="n">set_extent</span><span class="p">(</span><span class="n">map_extent</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">proj</span><span class="p">)</span> <span class="c1"># type: ignore</span>
<span class="linenos">37</span>
<span class="linenos">38</span><span class="c1"># 添加海岸线、国界</span>
<span class="linenos">39</span><span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">COASTLINE</span><span class="o">.</span><span class="n">with_scale</span><span class="p">(</span><span class="s1">&#39;50m&#39;</span><span class="p">),</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="linenos">40</span><span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">BORDERS</span><span class="o">.</span><span class="n">with_scale</span><span class="p">(</span><span class="s1">&#39;50m&#39;</span><span class="p">),</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="linenos">41</span>
<span class="linenos">42</span><span class="c1"># 添加经纬度坐标</span>
<span class="linenos">43</span><span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">map_extent</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">map_extent</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">crs</span><span class="o">=</span><span class="n">proj</span><span class="p">)</span>
<span class="linenos">44</span><span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">map_extent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">map_extent</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">crs</span><span class="o">=</span><span class="n">proj</span><span class="p">)</span>
<span class="linenos">45</span><span class="n">lon_formatter</span> <span class="o">=</span> <span class="n">LongitudeFormatter</span><span class="p">(</span><span class="n">degree_symbol</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">dateline_direction_label</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">46</span><span class="n">lat_formatter</span> <span class="o">=</span> <span class="n">LatitudeFormatter</span><span class="p">(</span><span class="n">degree_symbol</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="linenos">47</span><span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">lat_formatter</span><span class="p">)</span>
<span class="linenos">48</span><span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">lon_formatter</span><span class="p">)</span>
<span class="linenos">49</span>
<span class="linenos">50</span><span class="c1"># 获取画布位置大小参数</span>
<span class="linenos">51</span><span class="n">l</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span><span class="o">.</span><span class="n">bounds</span>
<span class="linenos">52</span>
<span class="linenos">53</span><span class="c1"># 添加色带</span>
<span class="linenos">54</span><span class="n">cax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">([</span><span class="n">l</span><span class="p">,</span> <span class="n">b</span> <span class="o">-</span> <span class="n">h</span> <span class="o">*</span> <span class="mf">0.06</span> <span class="o">-</span> <span class="mi">0</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">*</span> <span class="mf">0.02</span><span class="p">])</span>  <span class="c1"># type: ignore</span>
<span class="linenos">55</span><span class="n">cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">ticks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">)</span>
<span class="linenos">56</span><span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="linenos">57</span><span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$^{\circ}$C&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="linenos">58</span>
<span class="linenos">59</span><span class="c1"># 标题</span>
<span class="linenos">60</span><span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;站点数据原始绘图&#39;</span>
<span class="linenos">61</span><span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
<span class="linenos">62</span>
<span class="linenos">63</span><span class="c1"># 保存图片</span>
<span class="linenos">64</span><span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;站点数据原始绘图.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
<span class="linenos">65</span><span class="n">plt</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
<span class="linenos">66</span><span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
<span class="linenos">67</span><span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id5">
<h2>网格数据<a class="headerlink" href="#id5" title="Link to this heading">¶</a></h2>
<p><strong>网格数据</strong> 通常用 <a class="reference external" href="https://docs.xarray.dev/en/stable/getting-started-guide/quick-overview.html">Xarray</a> 库读取，这里我们使用 <em>GFS_test.nc</em>  <a class="footnote-reference brackets" href="#id12" id="id6" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a>：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">with</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="s2">&quot;GFS_test.nc&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span>
<span class="linenos">2</span>    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="p">((</span><span class="n">ds</span><span class="o">.</span><span class="n">lon</span> <span class="o">+</span> <span class="mi">180</span><span class="p">)</span> <span class="o">%</span> <span class="mi">360</span> <span class="o">-</span> <span class="mi">180</span><span class="p">))</span> <span class="c1"># 将经度范围从[0, 360]转换为[-180, 180]</span>
<span class="linenos">3</span>    <span class="n">dr</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;Temperature_isobaric&quot;</span><span class="p">]</span>
<span class="linenos">4</span>    <span class="n">dr</span> <span class="o">=</span> <span class="n">dr</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># first time step</span>
<span class="linenos">5</span>    <span class="n">dr</span> <span class="o">=</span> <span class="n">dr</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">isobaric3</span><span class="o">=</span><span class="mi">85000</span><span class="p">)</span> <span class="c1"># 850 hPa</span>
<span class="linenos">6</span>    <span class="n">dr</span> <span class="o">=</span> <span class="n">dr</span> <span class="o">-</span> <span class="mf">273.15</span> <span class="c1"># K to °C</span>
</pre></div>
</div>
<p>结构就像这样：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">xarray</span><span class="o">.</span><span class="n">DataArray</span> <span class="s1">&#39;Temperature_isobaric&#39;</span> <span class="p">(</span><span class="n">lat</span><span class="p">:</span> <span class="mi">46</span><span class="p">,</span> <span class="n">lon</span><span class="p">:</span> <span class="mi">101</span><span class="p">)</span><span class="o">&gt;</span>
<span class="p">[</span><span class="mi">4646</span> <span class="n">values</span> <span class="k">with</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">]</span>
<span class="n">Coordinates</span><span class="p">:</span>
    <span class="n">time</span>       <span class="n">datetime64</span><span class="p">[</span><span class="n">ns</span><span class="p">]</span> <span class="mi">2010</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">26</span><span class="n">T12</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>
    <span class="n">isobaric3</span>  <span class="n">float32</span> <span class="mf">8.5e+04</span>
  <span class="o">*</span> <span class="n">lat</span>        <span class="p">(</span><span class="n">lat</span><span class="p">)</span> <span class="n">float32</span> <span class="mf">65.0</span> <span class="mf">64.0</span> <span class="mf">63.0</span> <span class="mf">62.0</span> <span class="mf">61.0</span> <span class="o">...</span> <span class="mf">23.0</span> <span class="mf">22.0</span> <span class="mf">21.0</span> <span class="mf">20.0</span>
  <span class="o">*</span> <span class="n">lon</span>        <span class="p">(</span><span class="n">lon</span><span class="p">)</span> <span class="n">float32</span> <span class="o">-</span><span class="mf">150.0</span> <span class="o">-</span><span class="mf">149.0</span> <span class="o">-</span><span class="mf">148.0</span> <span class="o">-</span><span class="mf">147.0</span> <span class="o">...</span> <span class="o">-</span><span class="mf">52.0</span> <span class="o">-</span><span class="mf">51.0</span> <span class="o">-</span><span class="mf">50.0</span>
<span class="n">Attributes</span><span class="p">:</span>
    <span class="n">long_name</span><span class="p">:</span>  <span class="n">Temperature</span> <span class="o">@</span> <span class="n">Isobaric</span> <span class="n">surface</span>
    <span class="n">units</span><span class="p">:</span>      <span class="n">K</span>
</pre></div>
</div>
<p>其中， <code class="docutils literal notranslate"><span class="pre">lat</span></code> 和 <code class="docutils literal notranslate"><span class="pre">lon</span></code> 是这个数据的两个维度，即纬度和经度， <code class="docutils literal notranslate"><span class="pre">Coordinates</span></code> 展示了这各个维度对应的坐标信息，
<code class="docutils literal notranslate"><span class="pre">Attributes</span></code> 是一些属性信息，是个 <code class="docutils literal notranslate"><span class="pre">Dict</span></code> 。可以看到这个气温数据的单位是开尔文（K），将它减去 273.15 就是摄氏度的值。</p>
<p>把这个数据用网格填色的方式画在地图上：</p>
<figure class="align-default">
<img alt="网格数据原始绘图" src="_images/012.png" />
</figure>
<p>画图脚本如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="linenos"> 4</span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="linenos"> 5</span><span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
<span class="linenos"> 6</span><span class="kn">import</span><span class="w"> </span><span class="nn">cartopy.crs</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ccrs</span>
<span class="linenos"> 7</span><span class="kn">import</span><span class="w"> </span><span class="nn">cartopy.feature</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cfeature</span>
<span class="linenos"> 8</span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mpl</span>
<span class="linenos"> 9</span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="linenos">10</span><span class="kn">from</span><span class="w"> </span><span class="nn">cartopy.mpl.ticker</span><span class="w"> </span><span class="kn">import</span> <span class="n">LongitudeFormatter</span><span class="p">,</span> <span class="n">LatitudeFormatter</span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.sans-serif&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Microsoft YaHei&#39;</span><span class="p">]</span>
<span class="linenos">13</span><span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.unicode_minus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos">14</span>
<span class="linenos">15</span><span class="c1"># 读取数据</span>
<span class="linenos">16</span><span class="k">with</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="s2">&quot;GFS_test.nc&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span>
<span class="linenos">17</span>    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="p">((</span><span class="n">ds</span><span class="o">.</span><span class="n">lon</span> <span class="o">+</span> <span class="mi">180</span><span class="p">)</span> <span class="o">%</span> <span class="mi">360</span> <span class="o">-</span> <span class="mi">180</span><span class="p">))</span> <span class="c1"># 将经度范围从[0, 360]转换为[-180, 180]</span>
<span class="linenos">18</span>    <span class="n">dr</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;Temperature_isobaric&quot;</span><span class="p">]</span>
<span class="linenos">19</span>    <span class="n">dr</span> <span class="o">=</span> <span class="n">dr</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># first time step</span>
<span class="linenos">20</span>    <span class="n">dr</span> <span class="o">=</span> <span class="n">dr</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">isobaric3</span><span class="o">=</span><span class="mi">85000</span><span class="p">)</span> <span class="c1"># 850 hPa</span>
<span class="linenos">21</span>    <span class="n">dr</span> <span class="o">=</span> <span class="n">dr</span> <span class="o">-</span> <span class="mf">273.15</span> <span class="c1"># K to °C</span>
<span class="linenos">22</span>
<span class="linenos">23</span><span class="c1"># 计算经纬度范围</span>
<span class="linenos">24</span><span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">,</span> <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span> <span class="o">=</span> <span class="n">dr</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">dr</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">dr</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">dr</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="linenos">25</span><span class="n">lon_buffer</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">lon_max</span> <span class="o">-</span> <span class="n">lon_min</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.0</span>
<span class="linenos">26</span><span class="n">lat_buffer</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">lat_max</span> <span class="o">-</span> <span class="n">lat_min</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.0</span>
<span class="linenos">27</span><span class="n">map_extent</span> <span class="o">=</span> <span class="p">[</span><span class="n">lon_min</span> <span class="o">-</span> <span class="n">lon_buffer</span><span class="p">,</span> <span class="n">lon_max</span> <span class="o">+</span> <span class="n">lon_buffer</span><span class="p">,</span> <span class="n">lat_min</span> <span class="o">-</span> <span class="n">lat_buffer</span><span class="p">,</span> <span class="n">lat_max</span> <span class="o">+</span> <span class="n">lat_buffer</span><span class="p">]</span>
<span class="linenos">28</span>
<span class="linenos">29</span><span class="c1"># 绘图</span>
<span class="linenos">30</span><span class="n">proj</span> <span class="o">=</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()</span>
<span class="linenos">31</span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
<span class="linenos">32</span><span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">proj</span><span class="p">)</span>
<span class="linenos">33</span>
<span class="linenos">34</span><span class="n">cmap</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colormaps</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;jet&#39;</span><span class="p">)</span>
<span class="linenos">35</span><span class="n">LON</span><span class="p">,</span> <span class="n">LAT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">dr</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="n">dr</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>
<span class="linenos">36</span><span class="n">img</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">LON</span><span class="p">,</span> <span class="n">LAT</span><span class="p">,</span> <span class="n">dr</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">proj</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">37</span>
<span class="linenos">38</span><span class="c1"># 设置绘图经纬度区域</span>
<span class="linenos">39</span><span class="n">ax</span><span class="o">.</span><span class="n">set_extent</span><span class="p">(</span><span class="n">map_extent</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">proj</span><span class="p">)</span> <span class="c1"># type: ignore</span>
<span class="linenos">40</span>
<span class="linenos">41</span><span class="c1"># 添加海岸线、国界</span>
<span class="linenos">42</span><span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">COASTLINE</span><span class="o">.</span><span class="n">with_scale</span><span class="p">(</span><span class="s1">&#39;50m&#39;</span><span class="p">),</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="linenos">43</span><span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">BORDERS</span><span class="o">.</span><span class="n">with_scale</span><span class="p">(</span><span class="s1">&#39;50m&#39;</span><span class="p">),</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="linenos">44</span>
<span class="linenos">45</span><span class="c1"># 添加经纬度坐标</span>
<span class="linenos">46</span><span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">map_extent</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">map_extent</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">crs</span><span class="o">=</span><span class="n">proj</span><span class="p">)</span>
<span class="linenos">47</span><span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">map_extent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">map_extent</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">crs</span><span class="o">=</span><span class="n">proj</span><span class="p">)</span>
<span class="linenos">48</span><span class="n">lon_formatter</span> <span class="o">=</span> <span class="n">LongitudeFormatter</span><span class="p">(</span><span class="n">degree_symbol</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">dateline_direction_label</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">49</span><span class="n">lat_formatter</span> <span class="o">=</span> <span class="n">LatitudeFormatter</span><span class="p">(</span><span class="n">degree_symbol</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="linenos">50</span><span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">lat_formatter</span><span class="p">)</span>
<span class="linenos">51</span><span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">lon_formatter</span><span class="p">)</span>
<span class="linenos">52</span>
<span class="linenos">53</span><span class="c1"># 获取画布位置大小参数</span>
<span class="linenos">54</span><span class="n">l</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span><span class="o">.</span><span class="n">bounds</span>
<span class="linenos">55</span>
<span class="linenos">56</span><span class="c1"># 添加色带</span>
<span class="linenos">57</span><span class="n">cax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">([</span><span class="n">l</span><span class="p">,</span> <span class="n">b</span> <span class="o">-</span> <span class="n">h</span> <span class="o">*</span> <span class="mf">0.085</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">*</span> <span class="mf">0.03</span><span class="p">])</span>  <span class="c1"># type: ignore</span>
<span class="linenos">58</span><span class="n">cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">ticks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">)</span>
<span class="linenos">59</span><span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="linenos">60</span><span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$^{\circ}$C&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="linenos">61</span>
<span class="linenos">62</span><span class="c1"># 标题</span>
<span class="linenos">63</span><span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;网格数据原始绘图&#39;</span>
<span class="linenos">64</span><span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
<span class="linenos">65</span>
<span class="linenos">66</span><span class="c1"># 保存图片</span>
<span class="linenos">67</span><span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;网格数据原始绘图.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
<span class="linenos">68</span><span class="n">plt</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
<span class="linenos">69</span><span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
<span class="linenos">70</span><span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>在实际使用过程中，经常会有这样的需求：</p>
<ul class="simple">
<li><p>将<strong>网格数据</strong>插值到另一个分辨率不同的<strong>网格坐标</strong>上</p></li>
<li><p>将<strong>网格数据</strong>插值到<strong>站点数据</strong>的坐标上</p></li>
<li><p>将<strong>站点数据</strong>插值到<strong>网格数据</strong>的坐标上</p></li>
<li><p>…</p></li>
</ul>
<p>下面逐一说明。</p>
</section>
<section id="id7">
<h2>将网格数据插值到另一个坐标、分辨率不同的网格坐标上<a class="headerlink" href="#id7" title="Link to this heading">¶</a></h2>
<p>我们上面用到的 <em>GFS_test.nc</em> 的经纬度坐标 shape 为 <code class="docutils literal notranslate"><span class="pre">(lon:</span> <span class="pre">101,</span> <span class="pre">lat:</span> <span class="pre">46)</span></code> ，
lat 的数据范围是 [65, 20]，lon 的数据范围是 [-150, -50]， 分辨率是 1 度。
现在我们要将这个数据插值到一个分辨率是 0.1 度的网格坐标上，范围不变。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">with</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="s2">&quot;GFS_test.nc&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span>
<span class="linenos"> 2</span>    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="p">((</span><span class="n">ds</span><span class="o">.</span><span class="n">lon</span> <span class="o">+</span> <span class="mi">180</span><span class="p">)</span> <span class="o">%</span> <span class="mi">360</span> <span class="o">-</span> <span class="mi">180</span><span class="p">))</span> <span class="c1"># 将经度范围从[0, 360]转换为[-180, 180]</span>
<span class="linenos"> 3</span>    <span class="n">dr</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;Temperature_isobaric&quot;</span><span class="p">]</span>
<span class="linenos"> 4</span>    <span class="n">dr</span> <span class="o">=</span> <span class="n">dr</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># first time step</span>
<span class="linenos"> 5</span>    <span class="n">dr</span> <span class="o">=</span> <span class="n">dr</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">isobaric3</span><span class="o">=</span><span class="mi">85000</span><span class="p">)</span> <span class="c1"># 850 hPa</span>
<span class="linenos"> 6</span>    <span class="n">dr</span> <span class="o">=</span> <span class="n">dr</span> <span class="o">-</span> <span class="mf">273.15</span> <span class="c1"># K to °C</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="c1"># 分辨率为 0.1 度的网格</span>
<span class="linenos"> 9</span><span class="n">new_lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">dr</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">dr</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
<span class="linenos">10</span><span class="n">new_lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">dr</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">dr</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
<span class="linenos">11</span><span class="n">dr</span> <span class="o">=</span> <span class="n">dr</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="n">new_lat</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="n">new_lon</span><span class="p">)</span> <span class="c1"># 插值</span>
<span class="linenos">12</span><span class="n">dr</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="s2">&quot;GFS_test_850hPa_Temperature_0.1deg.nc&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>插值后的数据预览如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">xarray</span><span class="o">.</span><span class="n">DataArray</span> <span class="s1">&#39;Temperature_isobaric&#39;</span> <span class="p">(</span><span class="n">lat</span><span class="p">:</span> <span class="mi">451</span><span class="p">,</span> <span class="n">lon</span><span class="p">:</span> <span class="mi">1001</span><span class="p">)</span><span class="o">&gt;</span>
<span class="n">Coordinates</span><span class="p">:</span>
    <span class="n">time</span>       <span class="n">datetime64</span><span class="p">[</span><span class="n">ns</span><span class="p">]</span> <span class="mi">2010</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">26</span><span class="n">T12</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>
    <span class="n">isobaric3</span>  <span class="n">float32</span> <span class="mf">8.5e+04</span>
  <span class="o">*</span> <span class="n">lat</span>        <span class="p">(</span><span class="n">lat</span><span class="p">)</span> <span class="n">float64</span> <span class="mf">20.0</span> <span class="mf">20.1</span> <span class="mf">20.2</span> <span class="mf">20.3</span> <span class="mf">20.4</span> <span class="o">...</span> <span class="mf">64.7</span> <span class="mf">64.8</span> <span class="mf">64.9</span> <span class="mf">65.0</span>
  <span class="o">*</span> <span class="n">lon</span>        <span class="p">(</span><span class="n">lon</span><span class="p">)</span> <span class="n">float64</span> <span class="o">-</span><span class="mf">150.0</span> <span class="o">-</span><span class="mf">149.9</span> <span class="o">-</span><span class="mf">149.8</span> <span class="o">-</span><span class="mf">149.7</span> <span class="o">...</span> <span class="o">-</span><span class="mf">50.2</span> <span class="o">-</span><span class="mf">50.1</span> <span class="o">-</span><span class="mf">50.0</span>
</pre></div>
</div>
<p>可以看到数据的分辨率已经变成 0.1 度了，那么我们把这个插值后的数据画在地图上：</p>
<figure class="align-default">
<img alt="网格数据插值绘图" src="_images/022.png" />
</figure>
<p>和之前的图相比，插值后的数据明显更密集，没有了原来的网格状，而是更加平滑的分布。</p>
<figure class="align-default">
<img alt="网格数据原始插值对比绘图" src="_images/061.png" />
</figure>
</section>
<section id="id8">
<h2>将网格数据插值到站点数据上<a class="headerlink" href="#id8" title="Link to this heading">¶</a></h2>
<p>我们可以用 <a class="reference external" href="https://matplotlib.org/stable/gallery/misc/keyword_plotting.html#sphx-glr-gallery-misc-keyword-plotting-py">Scipy</a> 的插值函数方法一次性得到所有的插值结果：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
<span class="linenos"> 2</span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="linenos"> 3</span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="linenos"> 4</span><span class="kn">import</span><span class="w"> </span><span class="nn">scipy.interpolate</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">interpolate</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="k">def</span><span class="w"> </span><span class="nf">grid_to_station</span><span class="p">(</span><span class="n">station_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">grid_dr</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">):</span>
<span class="linenos"> 8</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;三维格点转插值到二维站点, 快速</span>
<span class="linenos"> 9</span>
<span class="linenos">10</span><span class="sd">    Args:</span>
<span class="linenos">11</span><span class="sd">        station_df(pd.DataFrame): 站点数据</span>
<span class="linenos">12</span><span class="sd">        grid_dr: 格点数据</span>
<span class="linenos">13</span>
<span class="linenos">14</span><span class="sd">    Returns:</span>
<span class="linenos">15</span><span class="sd">        (pd.DataFrame): 插值后的数据</span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">18</span>    <span class="n">grid_dr_lat</span><span class="p">,</span> <span class="n">grid_dr_lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">grid_dr</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">grid_dr</span><span class="o">.</span><span class="n">lon</span><span class="p">)</span>
<span class="linenos">19</span>    <span class="n">grid_dr_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">grid_dr_lat</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">grid_dr_lon</span><span class="o">.</span><span class="n">flatten</span><span class="p">()]))</span>
<span class="linenos">20</span>    <span class="n">grid_dr_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">grid_dr</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">21</span>    <span class="n">xi</span> <span class="o">=</span> <span class="p">(</span><span class="n">station_df</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">station_df</span><span class="o">.</span><span class="n">lon</span><span class="p">)</span>
<span class="linenos">22</span>    <span class="n">nc_interp_values</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">griddata</span><span class="p">(</span>
<span class="linenos">23</span>        <span class="n">grid_dr_points</span><span class="p">,</span> <span class="n">grid_dr_values</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<span class="linenos">24</span>    <span class="n">nc_interp_values</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">nc_interp_values</span><span class="p">)</span>
<span class="linenos">25</span>    <span class="n">df_nc_interp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;lat&quot;</span><span class="p">:</span><span class="n">station_df</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">:</span><span class="n">station_df</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span><span class="n">nc_interp_values</span><span class="p">})</span>
<span class="linenos">26</span>    <span class="k">return</span> <span class="n">df_nc_interp</span>
<span class="linenos">27</span>
<span class="linenos">28</span>
<span class="linenos">29</span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;UPA_obs.csv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
<span class="linenos">30</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">,</span> <span class="s2">&quot;temperature&quot;</span><span class="p">]]</span>
<span class="linenos">31</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;any&quot;</span><span class="p">)</span>
<span class="linenos">32</span><span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
<span class="linenos">33</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;temperature&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;temperature&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos">34</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="s2">&quot;value&quot;</span><span class="p">})</span>
<span class="linenos">35</span>
<span class="linenos">36</span>
<span class="linenos">37</span>
<span class="linenos">38</span><span class="k">with</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="s2">&quot;GFS_test.nc&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span>
<span class="linenos">39</span>    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="p">((</span><span class="n">ds</span><span class="o">.</span><span class="n">lon</span> <span class="o">+</span> <span class="mi">180</span><span class="p">)</span> <span class="o">%</span> <span class="mi">360</span> <span class="o">-</span> <span class="mi">180</span><span class="p">))</span> <span class="c1"># 将经度范围从[0, 360]转换为[-180, 180]</span>
<span class="linenos">40</span>    <span class="n">dr</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;Temperature_isobaric&quot;</span><span class="p">]</span>
<span class="linenos">41</span>    <span class="n">dr</span> <span class="o">=</span> <span class="n">dr</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># first time step</span>
<span class="linenos">42</span>    <span class="n">dr</span> <span class="o">=</span> <span class="n">dr</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">isobaric3</span><span class="o">=</span><span class="mi">85000</span><span class="p">)</span> <span class="c1"># 850 hPa</span>
<span class="linenos">43</span>    <span class="n">dr</span> <span class="o">=</span> <span class="n">dr</span> <span class="o">-</span> <span class="mf">273.15</span> <span class="c1"># K to °C</span>
<span class="linenos">44</span>
<span class="linenos">45</span>
<span class="linenos">46</span><span class="n">df_interp</span> <span class="o">=</span> <span class="n">grid_to_station</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">dr</span><span class="p">)</span>
<span class="linenos">47</span><span class="n">df_interp</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;grid_to_station.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>将插值后的数据打点画图：</p>
<figure class="align-default">
<img alt="网格数据插值到站点绘图" src="_images/031.png" />
</figure>
<p>可以看到，点的位置和 <code class="docutils literal notranslate"><span class="pre">UPA_obs.csv</span></code> 中的点位置是相同的，但数值是数据 <code class="docutils literal notranslate"><span class="pre">GFS_test.nc</span></code> 中的值。</p>
</section>
<section id="id9">
<h2>将站点数据插值到网格数据上（反距离权重插值）<a class="headerlink" href="#id9" title="Link to this heading">¶</a></h2>
<p>还会有一种需求，是将站点数据插值到指定精度的网格上。
原本为 <code class="docutils literal notranslate"><span class="pre">np.nan</span></code> 的数据要运用反距离权重插值预测出对应的值。
反距离权重插值的原理，简单讲就是被预测的值由它附近的点决定，与它距离越近的点权重越大，对它的影响就越大。</p>
<p>这里整理了国家气象信息中心开发的 <a class="reference external" href="https://github.com/nmcdev/meteva/blob/master/meteva/base/fun/interpolating.py">meteva</a> 库中提供的代码：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="linenos">  2</span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="linenos">  3</span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="linenos">  4</span><span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
<span class="linenos">  5</span><span class="kn">from</span><span class="w"> </span><span class="nn">scipy.spatial</span><span class="w"> </span><span class="kn">import</span> <span class="n">cKDTree</span>
<span class="linenos">  6</span>
<span class="linenos">  7</span>
<span class="linenos">  8</span><span class="c1"># 地球半径</span>
<span class="linenos">  9</span><span class="n">ER</span> <span class="o">=</span> <span class="mf">6371.229</span>
<span class="linenos"> 10</span>
<span class="linenos"> 11</span>
<span class="linenos"> 12</span><span class="k">def</span><span class="w"> </span><span class="nf">lon_lat_to_cartesian</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">R</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="linenos"> 13</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 14</span><span class="sd">    经度纬度信息转换为直角坐标系</span>
<span class="linenos"> 15</span>
<span class="linenos"> 16</span><span class="sd">    calculates lon, lat coordinates of a point on a sphere with</span>
<span class="linenos"> 17</span><span class="sd">    radius R</span>
<span class="linenos"> 18</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 19</span>    <span class="n">lon_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span>
<span class="linenos"> 20</span>    <span class="n">lat_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span>
<span class="linenos"> 21</span>    <span class="n">xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">lon</span><span class="p">),</span> <span class="mi">3</span><span class="p">))</span>
<span class="linenos"> 22</span>    <span class="n">xyz</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">R</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat_r</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lon_r</span><span class="p">)</span>
<span class="linenos"> 23</span>    <span class="n">xyz</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">R</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat_r</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lon_r</span><span class="p">)</span>
<span class="linenos"> 24</span>    <span class="n">xyz</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">R</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lat_r</span><span class="p">)</span>
<span class="linenos"> 25</span>    <span class="k">return</span> <span class="n">xyz</span>
<span class="linenos"> 26</span>
<span class="linenos"> 27</span>
<span class="linenos"> 28</span><span class="k">def</span><span class="w"> </span><span class="nf">grid_data</span><span class="p">(</span><span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_len</span><span class="p">,</span> <span class="n">lon_res</span><span class="p">,</span> <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_len</span><span class="p">,</span> <span class="n">lat_res</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 29</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 30</span><span class="sd">    返回一个DataArray，其维度信息和grid描述一致，数组里面的值为0.</span>
<span class="linenos"> 31</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 32</span>    <span class="c1"># 通过起始经纬度和格距计算经纬度格点数</span>
<span class="linenos"> 33</span>    <span class="n">lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lon_len</span><span class="p">)</span> <span class="o">*</span> <span class="n">lon_res</span> <span class="o">+</span> <span class="n">lon_min</span>
<span class="linenos"> 34</span>    <span class="n">lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lat_len</span><span class="p">)</span> <span class="o">*</span> <span class="n">lat_res</span> <span class="o">+</span> <span class="n">lat_min</span>
<span class="linenos"> 35</span>    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 36</span>        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">lat_len</span><span class="p">,</span> <span class="n">lon_len</span><span class="p">))</span>
<span class="linenos"> 37</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 38</span>        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">lat_len</span><span class="p">,</span> <span class="n">lon_len</span><span class="p">)</span>
<span class="linenos"> 39</span>
<span class="linenos"> 40</span>    <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
<span class="linenos"> 41</span>        <span class="n">data</span><span class="p">,</span>
<span class="linenos"> 42</span>        <span class="n">coords</span><span class="o">=</span><span class="p">{</span>
<span class="linenos"> 43</span>            <span class="s1">&#39;lat&#39;</span><span class="p">:</span> <span class="n">lat</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">:</span> <span class="n">lon</span><span class="p">},</span>
<span class="linenos"> 44</span>        <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">]</span>
<span class="linenos"> 45</span>    <span class="p">)</span>
<span class="linenos"> 46</span>
<span class="linenos"> 47</span>
<span class="linenos"> 48</span><span class="k">def</span><span class="w"> </span><span class="nf">grd_info</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span> <span class="n">vres</span><span class="p">):</span>
<span class="linenos"> 49</span>    <span class="n">vlen</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">vmax</span> <span class="o">-</span> <span class="n">vmin</span><span class="p">)</span> <span class="o">/</span> <span class="n">vres</span>
<span class="linenos"> 50</span>    <span class="n">error</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">vlen</span><span class="p">)</span> <span class="o">-</span> <span class="n">vlen</span><span class="p">)</span><span class="o">/</span><span class="n">vlen</span>
<span class="linenos"> 51</span>    <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">):</span>
<span class="linenos"> 52</span>        <span class="n">vlen</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">vlen</span><span class="p">))</span>
<span class="linenos"> 53</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 54</span>        <span class="n">vlen</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">vlen</span><span class="p">))</span>
<span class="linenos"> 55</span>    <span class="k">return</span> <span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vlen</span><span class="p">,</span> <span class="n">vres</span><span class="p">)</span>
<span class="linenos"> 56</span>
<span class="linenos"> 57</span>
<span class="linenos"> 58</span><span class="k">def</span><span class="w"> </span><span class="nf">interp_sg_idw</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">lon_info</span><span class="p">,</span> <span class="n">lat_info</span><span class="p">,</span> <span class="n">effectR</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">nearNum</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">decrease</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="linenos"> 59</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;站点到格点IDW插值</span>
<span class="linenos"> 60</span>
<span class="linenos"> 61</span><span class="sd">    Args:</span>
<span class="linenos"> 62</span><span class="sd">        sta(pd.Dataframe): 站点数据, lat, lon, data</span>
<span class="linenos"> 63</span><span class="sd">        lon_info(tuple): 目标网格的经度信息, (起始经度, 结束经度, 分辨率)</span>
<span class="linenos"> 64</span><span class="sd">        lat_info(tuple): 目标网格的纬度信息, (起始纬度, 结束纬度, 分辨率)</span>
<span class="linenos"> 65</span><span class="sd">        effectR(float): 最大的插值半径, 单位km</span>
<span class="linenos"> 66</span><span class="sd">        nearNum(int): 插值选择的临近站点的个数, nearNum =1时即为临近点插值</span>
<span class="linenos"> 67</span><span class="sd">        decrease(int): 站点权重随距离幂次衰减，即 站点权重 = 1 /(距离 ** decrease), 其中decrease是幂函数的指数部分参数</span>
<span class="linenos"> 68</span>
<span class="linenos"> 69</span><span class="sd">    Returns:</span>
<span class="linenos"> 70</span><span class="sd">        (xr.DataArray): 插值后的网格</span>
<span class="linenos"> 71</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 72</span>    <span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_len</span><span class="p">,</span> <span class="n">lon_res</span> <span class="o">=</span> <span class="n">grd_info</span><span class="p">(</span><span class="o">*</span><span class="n">lon_info</span><span class="p">)</span>
<span class="linenos"> 73</span>    <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_len</span><span class="p">,</span> <span class="n">lat_res</span> <span class="o">=</span> <span class="n">grd_info</span><span class="p">(</span><span class="o">*</span><span class="n">lat_info</span><span class="p">)</span>
<span class="linenos"> 74</span>    <span class="n">xyz_sta</span> <span class="o">=</span> <span class="n">lon_lat_to_cartesian</span><span class="p">(</span><span class="n">sta</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">sta</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">R</span><span class="o">=</span><span class="n">ER</span><span class="p">)</span>
<span class="linenos"> 75</span>    <span class="n">lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lon_len</span><span class="p">)</span> <span class="o">*</span> <span class="n">lon_res</span> <span class="o">+</span> <span class="n">lon_min</span>
<span class="linenos"> 76</span>    <span class="n">lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lat_len</span><span class="p">)</span> <span class="o">*</span> <span class="n">lat_res</span> <span class="o">+</span> <span class="n">lat_min</span>
<span class="linenos"> 77</span>    <span class="n">grid_lon</span><span class="p">,</span> <span class="n">grid_lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span>
<span class="linenos"> 78</span>    <span class="n">xyz_grid</span> <span class="o">=</span> <span class="n">lon_lat_to_cartesian</span><span class="p">(</span><span class="n">grid_lon</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">grid_lat</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">R</span><span class="o">=</span><span class="n">ER</span><span class="p">)</span>
<span class="linenos"> 79</span>    <span class="n">tree</span> <span class="o">=</span> <span class="n">cKDTree</span><span class="p">(</span><span class="n">xyz_sta</span><span class="p">)</span>
<span class="linenos"> 80</span>    <span class="c1"># d,inds 分别是站点到格点的距离和id</span>
<span class="linenos"> 81</span>    <span class="k">if</span> <span class="n">nearNum</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">sta</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
<span class="linenos"> 82</span>        <span class="n">nearNum</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sta</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="linenos"> 83</span>    <span class="n">d</span><span class="p">,</span> <span class="n">inds</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">xyz_grid</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">nearNum</span><span class="p">)</span>
<span class="linenos"> 84</span>    <span class="k">if</span> <span class="n">nearNum</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos"> 85</span>        <span class="n">d</span> <span class="o">+=</span> <span class="mf">1e-6</span>
<span class="linenos"> 86</span>        <span class="n">w</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">d</span> <span class="o">**</span> <span class="n">decrease</span>
<span class="linenos"> 87</span>        <span class="n">input_dat</span> <span class="o">=</span> <span class="n">sta</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos"> 88</span>        <span class="n">dat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">input_dat</span><span class="p">[</span><span class="n">inds</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 89</span>        <span class="n">bg</span> <span class="o">=</span> <span class="n">grid_data</span><span class="p">(</span><span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_len</span><span class="p">,</span> <span class="n">lon_res</span><span class="p">,</span> <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_len</span><span class="p">,</span> <span class="n">lat_res</span><span class="p">)</span>
<span class="linenos"> 90</span>        <span class="n">bg_dat</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="linenos"> 91</span>        <span class="n">dat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">d</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">effectR</span><span class="p">,</span> <span class="n">bg_dat</span><span class="p">,</span> <span class="n">dat</span><span class="p">)</span>
<span class="linenos"> 92</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 93</span>        <span class="n">input_dat</span> <span class="o">=</span> <span class="n">sta</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="linenos"> 94</span>        <span class="n">dat</span> <span class="o">=</span> <span class="n">input_dat</span><span class="p">[</span><span class="n">inds</span><span class="p">]</span>
<span class="linenos"> 95</span>        <span class="n">bg</span> <span class="o">=</span> <span class="n">grid_data</span><span class="p">(</span><span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_len</span><span class="p">,</span> <span class="n">lon_res</span><span class="p">,</span> <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_len</span><span class="p">,</span> <span class="n">lat_res</span><span class="p">)</span>
<span class="linenos"> 96</span>        <span class="n">bg_dat</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="linenos"> 97</span>        <span class="n">dat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">d</span><span class="p">[:]</span> <span class="o">&gt;</span> <span class="n">effectR</span><span class="p">,</span> <span class="n">bg_dat</span><span class="p">,</span> <span class="n">dat</span><span class="p">)</span>
<span class="linenos"> 98</span>    <span class="n">dat</span> <span class="o">=</span> <span class="n">dat</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="linenos"> 99</span>    <span class="n">grd</span> <span class="o">=</span> <span class="n">grid_data</span><span class="p">(</span><span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_len</span><span class="p">,</span> <span class="n">lon_res</span><span class="p">,</span> <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_len</span><span class="p">,</span> <span class="n">lat_res</span><span class="p">,</span> <span class="n">dat</span><span class="p">)</span>
<span class="linenos">100</span>    <span class="k">return</span> <span class="n">grd</span>
<span class="linenos">101</span>
<span class="linenos">102</span>
<span class="linenos">103</span><span class="c1"># 站点数据</span>
<span class="linenos">104</span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;UPA_obs.csv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
<span class="linenos">105</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">,</span> <span class="s2">&quot;temperature&quot;</span><span class="p">]]</span>
<span class="linenos">106</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;any&quot;</span><span class="p">)</span>
<span class="linenos">107</span><span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
<span class="linenos">108</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;temperature&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;temperature&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<span class="linenos">109</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="s2">&quot;value&quot;</span><span class="p">})</span>
<span class="linenos">110</span><span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">,</span> <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">df</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">df</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">df</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="linenos">111</span><span class="n">lon_buffer</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">lon_max</span> <span class="o">-</span> <span class="n">lon_min</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span>
<span class="linenos">112</span><span class="n">lat_buffer</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">lat_max</span> <span class="o">-</span> <span class="n">lat_min</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span>
<span class="linenos">113</span><span class="n">nc_interp</span> <span class="o">=</span> <span class="n">interp_sg_idw</span><span class="p">(</span>
<span class="linenos">114</span>    <span class="n">df</span><span class="p">,</span>
<span class="linenos">115</span>    <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="n">lon_buffer</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="n">lon_buffer</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
<span class="linenos">116</span>    <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="n">lat_buffer</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="n">lat_buffer</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
<span class="linenos">117</span>    <span class="n">effectR</span><span class="o">=</span><span class="mi">10000</span>
<span class="linenos">118</span><span class="p">)</span>
<span class="linenos">119</span><span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">({</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">nc_interp</span><span class="p">})</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="s2">&quot;station_to_grid.nc&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>插值后的数据填色绘图如下：</p>
<figure class="align-default">
<img alt="站点IDW插值到网格" src="_images/041.png" />
</figure>
<p>站点数据和插值后的对比图如下：</p>
<figure class="align-default">
<img alt="站点数据插值到网格对比图" src="_images/051.png" />
</figure>
<p>从这个对比图可以看到原站点数值和插值后的数值之间的对应情况。</p>
<blockquote>
<div><p>注：</p>
<p>从颜色分布来看，我注意到这个插值结果的数值似乎有些偏大，不知道是这个插值算法就该如此还是代码有问题，待后续研究。</p>
</div></blockquote>
</section>
<section id="id10">
<h2>示例数据下载<a class="headerlink" href="#id10" title="Link to this heading">¶</a></h2>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="id11" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id4">1</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://github.com/Unidata/MetPy/blob/main/staticdata/UPA_obs.csv">UPA_obs.csv</a></p>
</aside>
<aside class="footnote brackets" id="id12" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id6">2</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://github.com/Unidata/MetPy/blob/main/staticdata/GFS_test.nc">GFS_test.nc</a></p>
</aside>
</aside>
</section>
</section>



        <script>
            function loadUtterances(theme) {
                const script = document.createElement('script');
                script.src = 'https://utteranc.es/client.js';
                script.setAttribute('repo', 'junsircoding/blog_comments');
                script.setAttribute('label', 'blog comments');
                script.setAttribute('issue-term', 'title');
                script.setAttribute('theme', theme === 'dark' ? 'github-dark' : 'github-light');
                script.setAttribute('crossorigin', 'anonymous');
                script.async = true;
                const utterancesContainer = document.getElementById('utterances-container');
                utterancesContainer.innerHTML = '';
                utterancesContainer.appendChild(script);
            }
        
            const pydocthemeDark = document.getElementById('pydoctheme_dark_css')
            const pygmentsDark = document.getElementById('pygments_dark_css')
            const themeSelectors = document.getElementsByClassName('theme-selector')

            function activateTheme(theme) {
                localStorage.setItem('currentTheme', theme);
                [...themeSelectors].forEach(e => e.value = theme)
                switch (theme) {
                    case 'light':
                    pydocthemeDark.media = 'not all'
                    pygmentsDark.media = 'not all'
                    break;
                    case 'dark':
                    pydocthemeDark.media = 'all'
                    pygmentsDark.media = 'all'
                    break;
                    default:
                    // auto
                    pydocthemeDark.media = '(prefers-color-scheme: dark)'
                    pygmentsDark.media = '(prefers-color-scheme: dark)'
                }
            }

            function changeTheme(value) {
                const theme = value === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : value;
                document.documentElement.setAttribute('data-theme', theme);
                activateTheme(value)
                loadUtterances(theme);
            }
            
            document.addEventListener('DOMContentLoaded', function () {
                // Initialize theme on page load
                const initialTheme = document.documentElement.getAttribute('data-theme') || 'auto';
                const currentTheme = initialTheme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : initialTheme;
                loadUtterances(currentTheme);
                activateTheme(initialTheme);
            });
        </script>
        
        <hr/>
        <!-- Utterances comments section -->
        <div id="utterances-container"></div>
        

        <div class="clearer"></div>
      </div>
    </div>
    

  </div>
  
  
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index.html">
              <img class="logo" src="_static/logo.png" alt="Logo"/>
            </a></p>
  <div>
    <h3><a href="index.html">目录</a></h3>
    <ul>
<li><a class="reference internal" href="#">处理气象数据常用的插值方法</a><ul>
<li><a class="reference internal" href="#id3">站点数据</a></li>
<li><a class="reference internal" href="#id5">网格数据</a></li>
<li><a class="reference internal" href="#id7">将网格数据插值到另一个坐标、分辨率不同的网格坐标上</a></li>
<li><a class="reference internal" href="#id8">将网格数据插值到站点数据上</a></li>
<li><a class="reference internal" href="#id9">将站点数据插值到网格数据上（反距离权重插值）</a></li>
<li><a class="reference internal" href="#id10">示例数据下载</a></li>
</ul>
</li>
</ul>

  </div>
        </div>
      </div>
  
  

    <div class="clearer"></div>
</div> 
<div class="related">
    <ul>
        <li class="nav-item nav-item-this">
            &copy; 
            版权所有
             2023-2025, 小骏不抬杠.
        </li>
        &nbsp;&nbsp;&nbsp;
        <li class="nav-item nav-item-this"><a href="mailto:junsircoding@foxmail.com" target="_blank">Email</a></li>
        &nbsp;&nbsp;&nbsp;
        <li class="nav-item nav-item-this"><a href="https://space.bilibili.com/39994473/video" target="_blank">Bilibili</a></li>
    </ul>
</div>

  </body>
</html>